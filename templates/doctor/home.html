{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block description %}{{ description }}{% endblock %}

{% block extra_css %}
<style>
    .prediction-card {
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .loading-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="gradient-bg text-white py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-6">
            AI-Powered Crop Monitoring and Detection
        </h1>
        <p class="text-xl md:text-2xl mb-8 text-gray-100">
            Upload images of crop leaves to detect diseases and get instant treatment recommendations
        </p>
        <div class="flex flex-wrap justify-center gap-4">
            <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-4 py-2">
                <i class="fas fa-brain mr-2"></i>
                <span>Advanced AI</span>
            </div>
            <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-4 py-2">
                <i class="fas fa-leaf mr-2"></i>
                <span>14+ Crops</span>
            </div>
            <div class="flex items-center bg-white bg-opacity-20 rounded-lg px-4 py-2">
                <i class="fas fa-bug mr-2"></i>
                <span>38+ Diseases</span>
            </div>
        </div>
    </div>
</section>

<!-- Upload Section -->
<section class="py-16 bg-white">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
                Upload Your Crop Image
            </h2>
            <p class="text-lg text-gray-600">
                Take a clear photo of the affected plant leaf and upload it for instant disease detection
            </p>
        </div>

        <!-- Upload Area -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div id="upload-area" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                <div id="upload-content">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">
                        Drag & Drop your image here
                    </h3>
                    <p class="text-gray-500 mb-4">
                        or click to browse files
                    </p>
                    <button id="browse-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                        Choose File
                    </button>
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                </div>
                
                <!-- Image Preview -->
                <div id="image-preview" class="hidden">
                    <img id="preview-img" class="max-w-full h-64 object-contain mx-auto mb-4 rounded-lg" alt="Preview">
                    <div class="flex justify-center space-x-4">
                        <button type="submit" id="analyze-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-search mr-2"></i>Analyze Image
                        </button>
                        <button id="change-image-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                            Change Image
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden mt-8 text-center">
            <div class="loading-spinner inline-block w-8 h-8 border-4 border-green-600 border-t-transparent rounded-full mb-4"></div>
            <p class="text-lg text-gray-700">Analyzing your image...</p>
            <p class="text-sm text-gray-500">This may take a few seconds</p>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden mt-8">
            <div class="prediction-card bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Analysis Results</h3>
                
                <!-- Prediction Results -->
                <div id="prediction-results" class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-green-800 mb-2">Crop Type</h4>
                            <p id="predicted-crop" class="text-green-700 text-lg"></p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">Disease</h4>
                            <p id="predicted-disease" class="text-red-700 text-lg"></p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">Confidence</h4>
                            <p id="confidence-score" class="text-blue-700 text-lg"></p>
                        </div>
                    </div>
                </div>

                <!-- Treatment Recommendations -->
                <div id="treatments-section" class="mb-6">
                    <h4 class="text-xl font-semibold text-gray-900 mb-4">Treatment Recommendations</h4>
                    <div id="treatments-list" class="space-y-4">
                        <!-- Treatments will be populated here -->
                    </div>
                </div>

                <!-- Crop Tips -->
                <div id="tips-section">
                    <h4 class="text-xl font-semibold text-gray-900 mb-4">Care Tips</h4>
                    <div id="tips-list" class="space-y-4">
                        <!-- Tips will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Features Section -->
<section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
                Why Choose AgroDoctor?
            </h2>
            <p class="text-lg text-gray-600">
                Advanced AI technology combined with comprehensive agricultural knowledge
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-brain text-2xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">AI-Powered Detection</h3>
                <p class="text-gray-600">
                    State-of-the-art deep learning models trained on thousands of plant images for accurate disease identification.
                </p>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-leaf text-2xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Comprehensive Database</h3>
                <p class="text-gray-600">
                    Covers 14+ crop types and 38+ diseases with detailed treatment recommendations and care tips.
                </p>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 text-center">
                <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-mobile-alt text-2xl text-purple-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Instant Results</h3>
                <p class="text-gray-600">
                    Get immediate analysis results with treatment recommendations and preventive care tips.
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Supported Crops Section -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
                Supported Crops
            </h2>
            <p class="text-lg text-gray-600">
                Our AI can detect diseases in a wide variety of crops
            </p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
            <div class="text-center">
                <div class="bg-red-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-apple-alt text-2xl text-red-600"></i>
                </div>
                <p class="text-sm font-medium">Apple</p>
            </div>
            <div class="text-center">
                <div class="bg-blue-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-blue-600"></i>
                </div>
                <p class="text-sm font-medium">Blueberry</p>
            </div>
            <div class="text-center">
                <div class="bg-red-200 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-red-700"></i>
                </div>
                <p class="text-sm font-medium">Cherry</p>
            </div>
            <div class="text-center">
                <div class="bg-yellow-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-yellow-600"></i>
                </div>
                <p class="text-sm font-medium">Corn</p>
            </div>
            <div class="text-center">
                <div class="bg-purple-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-purple-600"></i>
                </div>
                <p class="text-sm font-medium">Grape</p>
            </div>
            <div class="text-center">
                <div class="bg-orange-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-orange-600"></i>
                </div>
                <p class="text-sm font-medium">Orange</p>
            </div>
            <div class="text-center">
                <div class="bg-pink-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-pink-600"></i>
                </div>
                <p class="text-sm font-medium">Peach</p>
            </div>
            <div class="text-center">
                <div class="bg-red-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-pepper-hot text-2xl text-red-600"></i>
                </div>
                <p class="text-sm font-medium">Pepper</p>
            </div>
            <div class="text-center">
                <div class="bg-brown-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-yellow-800"></i>
                </div>
                <p class="text-sm font-medium">Potato</p>
            </div>
            <div class="text-center">
                <div class="bg-red-200 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-red-700"></i>
                </div>
                <p class="text-sm font-medium">Raspberry</p>
            </div>
            <div class="text-center">
                <div class="bg-green-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-green-600"></i>
                </div>
                <p class="text-sm font-medium">Soybean</p>
            </div>
            <div class="text-center">
                <div class="bg-orange-200 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-orange-700"></i>
                </div>
                <p class="text-sm font-medium">Squash</p>
            </div>
            <div class="text-center">
                <div class="bg-red-300 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-red-800"></i>
                </div>
                <p class="text-sm font-medium">Strawberry</p>
            </div>
            <div class="text-center">
                <div class="bg-red-100 rounded-lg p-4 mb-2">
                    <i class="fas fa-seedling text-2xl text-red-600"></i>
                </div>
                <p class="text-sm font-medium">Tomato</p>
            </div>
        </div>

        <div class="text-center mt-8">
            <a href="{% url 'doctor:crops_list' %}" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                View All Crops
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const browseBtn = document.getElementById('browse-btn');
    const imagePreview = document.getElementById('image-preview');
    const uploadContent = document.getElementById('upload-content');
    const previewImg = document.getElementById('preview-img');
    const analyzeBtn = document.getElementById('analyze-btn');
    const changeImageBtn = document.getElementById('change-image-btn');
    const loadingState = document.getElementById('loading-state');
    const resultsSection = document.getElementById('results-section');

    let selectedFile = null;

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // Browse button click
    browseBtn.addEventListener('click', function () {
        fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', function (e) {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    // Change image button
    changeImageBtn.addEventListener('click', function () {
        resetUpload();
    });

    // Analyze button (uses async/await version)
    analyzeBtn.addEventListener('click', async function () {
        if (selectedFile) {
            await analyzeImage(selectedFile);
        }
    });

    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            return;
        }

        selectedFile = file;
        const reader = new FileReader();
        reader.onload = function (e) {
            previewImg.src = e.target.result;
            uploadContent.classList.add('hidden');
            imagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        selectedFile = null;
        fileInput.value = '';
        uploadContent.classList.remove('hidden');
        imagePreview.classList.add('hidden');
        resultsSection.classList.add('hidden');
        loadingState.classList.add('hidden');
    }

    async function analyzeImage(file) {
        loadingState.classList.remove('hidden');
        resultsSection.classList.add('hidden');

        const formData = new FormData();
        formData.append('image', file);

        try {
    const response = await fetch('/classify/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    });

    const data = await response.json();
            loadingState.classList.add('hidden');

            if (data.success) {
                displayResults(data);
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            loadingState.classList.add('hidden');
            console.error('Error:', error);
            alert('An error occurred while analyzing the image.');
        }
    }

    function displayResults(data) {
        document.getElementById('predicted-crop').textContent = data.prediction.crop;
        document.getElementById('predicted-disease').textContent = data.prediction.disease;
        document.getElementById('confidence-score').textContent = (data.prediction.confidence).toFixed(1) + '%';

        // Treatments
        const treatmentsList = document.getElementById('treatments-list');
        treatmentsList.innerHTML = '';
        if (Array.isArray(data.treatments) && data.treatments.length > 0) {
            data.treatments.forEach(treatment => {
                const treatmentDiv = document.createElement('div');
                treatmentDiv.className = 'bg-blue-50 p-4 rounded-lg';
                const desc = treatment.description || '';
                const type = treatment.treatment_type || '';
                const eff = treatment.effectiveness || '';
                treatmentDiv.innerHTML = `
                    <h5 class="font-semibold text-blue-800 mb-2">${treatment.title}</h5>
                    <p class="text-blue-700 mb-2">${desc}</p>
                    <div class="flex items-center space-x-4 text-sm">
                        <span class="bg-blue-200 text-blue-800 px-2 py-1 rounded">${type}</span>
                        <span class="bg-green-200 text-green-800 px-2 py-1 rounded">${eff} effectiveness</span>
                    </div>
                    <p class="text-blue-600 mt-2"><strong>Instructions:</strong> ${treatment.instructions}</p>
                `;
                treatmentsList.appendChild(treatmentDiv);
            });
        } else {
            treatmentsList.innerHTML = '<p class="text-gray-500">No specific treatments found for this disease.</p>';
        }

        // Crop Tips
        const tipsList = document.getElementById('tips-list');
        tipsList.innerHTML = '';
        if (data.crop_tips.length > 0) {
            data.crop_tips.forEach(tip => {
                const tipDiv = document.createElement('div');
                tipDiv.className = 'bg-green-50 p-4 rounded-lg';
                tipDiv.innerHTML = `
                    <h5 class="font-semibold text-green-800 mb-2">${tip.title}</h5>
                    <p class="text-green-700">${tip.content}</p>
                    <div class="flex items-center space-x-4 text-sm mt-2">
                        <span class="bg-green-200 text-green-800 px-2 py-1 rounded">${tip.tip_type}</span>
                        <span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded">${tip.season}</span>
                    </div>
                `;
                tipsList.appendChild(tipDiv);
            });
        } else {
            tipsList.innerHTML = '<p class="text-gray-500">No specific care tips found for this crop.</p>';
        }

        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});


</script>
{% endblock %} 